name: Release

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:

jobs:
  build-linux:
    name: Build Linux
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential pkg-config libssl-dev

      - name: Build
        run: |
          make clean || true
          make -j$(nproc) RELEASE_CFLAGS="-O2 -DNDEBUG" RELEASE_CXXFLAGS="-O2 -DNDEBUG -fno-exceptions"
          strip bin/spf
          file bin/spf
          ./bin/spf --help

      - name: Create DEB package
        run: |
          VERSION="${GITHUB_REF_NAME#v}"
          [ -z "$VERSION" ] && VERSION="2.1.1"
          mkdir -p pkg/DEBIAN pkg/usr/local/bin
          cp bin/spf pkg/usr/local/bin/
          cat > pkg/DEBIAN/control << EOF
          Package: spf
          Version: $VERSION
          Section: net
          Priority: optional
          Architecture: amd64
          Maintainer: ${{ github.repository_owner }}
          Description: SPF - Simple Port Forwarder and Tunnel
           Fast, secure, lightweight TCP proxy with tunnel support.
          EOF
          dpkg-deb --build pkg spf_${VERSION}_amd64.deb

      - name: Create RPM package
        run: |
          VERSION="${GITHUB_REF_NAME#v}"
          [ -z "$VERSION" ] && VERSION="2.1.1"
          sudo apt-get install -y rpm
          mkdir -p rpmbuild/{BUILD,RPMS,SOURCES,SPECS,SRPMS}
          cp bin/spf rpmbuild/SOURCES/
          cat > rpmbuild/SPECS/spf.spec << EOF
          Name: spf
          Version: $VERSION
          Release: 1
          Summary: Simple Port Forwarder and Tunnel
          License: GPL-2.0
          
          %description
          Fast, secure, lightweight TCP proxy with tunnel support.
          
          %install
          mkdir -p %{buildroot}/usr/local/bin
          cp %{_sourcedir}/spf %{buildroot}/usr/local/bin/
          
          %files
          /usr/local/bin/spf
          EOF
          rpmbuild --define "_topdir $(pwd)/rpmbuild" -bb rpmbuild/SPECS/spf.spec
          cp rpmbuild/RPMS/x86_64/*.rpm ./spf-${VERSION}-1.x86_64.rpm || cp rpmbuild/RPMS/*/*.rpm ./spf-${VERSION}-1.x86_64.rpm

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: linux-builds
          path: |
            bin/spf
            *.deb
            *.rpm

  build-windows:
    name: Build Windows
    runs-on: windows-latest
    defaults:
      run:
        shell: msys2 {0}
    steps:
      - uses: actions/checkout@v4

      - uses: msys2/setup-msys2@v2
        with:
          msystem: MINGW64
          update: true
          install: >-
            mingw-w64-x86_64-gcc
            mingw-w64-x86_64-openssl
            mingw-w64-x86_64-make

      - name: Build
        run: |
          export PATH="/mingw64/bin:$PATH"
          mingw32-make clean || true
          mingw32-make CC=gcc CXX=g++ \
            CFLAGS="-Wall -O2 -DNDEBUG -I/mingw64/include" \
            CXXFLAGS="-Wall -O2 -DNDEBUG -std=c++11 -fno-exceptions -I/mingw64/include" \
            LDFLAGS="-L/mingw64/lib -static-libgcc -static-libstdc++" \
            LIBS="-lssl -lcrypto -lws2_32 -lcrypt32 -lgdi32" \
            TARGET=spf.exe \
            -j$(nproc)
          strip bin/spf.exe || true
          ls -la bin/

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: windows-build
          path: bin/spf.exe

  build-macos:
    name: Build macOS
    strategy:
      matrix:
        include:
          - runner: macos-13
            arch: x86_64
          - runner: macos-14
            arch: arm64
    runs-on: ${{ matrix.runner }}
    steps:
      - uses: actions/checkout@v4

      - name: Install dependencies
        run: brew install openssl@3

      - name: Build
        run: |
          if [ "${{ matrix.arch }}" = "arm64" ]; then
            export LDFLAGS="-L/opt/homebrew/opt/openssl@3/lib"
            export CFLAGS="-I/opt/homebrew/opt/openssl@3/include"
            export CXXFLAGS="-I/opt/homebrew/opt/openssl@3/include"
          else
            export LDFLAGS="-L/usr/local/opt/openssl@3/lib"
            export CFLAGS="-I/usr/local/opt/openssl@3/include"
            export CXXFLAGS="-I/usr/local/opt/openssl@3/include"
          fi
          make clean || true
          make RELEASE_CFLAGS="-O2 -DNDEBUG $CFLAGS" \
               RELEASE_CXXFLAGS="-O2 -DNDEBUG -fno-exceptions $CXXFLAGS" \
               LDFLAGS="$LDFLAGS" \
               -j$(sysctl -n hw.ncpu)
          strip bin/spf
          file bin/spf
          ./bin/spf --help

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: macos-${{ matrix.arch }}
          path: bin/spf

  release:
    name: Create Release
    needs: [build-linux, build-windows, build-macos]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    permissions:
      contents: write
    steps:
      - uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Prepare release files
        run: |
          mkdir -p release
          VERSION="${GITHUB_REF_NAME#v}"
          
          # Linux
          cp artifacts/linux-builds/spf release/spf-linux-amd64
          cp artifacts/linux-builds/*.deb release/
          cp artifacts/linux-builds/*.rpm release/
          
          # Windows
          cp artifacts/windows-build/spf.exe release/spf-windows-amd64.exe
          
          # macOS
          cp artifacts/macos-x86_64/spf release/spf-macos-x86_64
          cp artifacts/macos-arm64/spf release/spf-macos-arm64
          
          # Checksums
          cd release
          sha256sum * > SHA256SUMS.txt
          cat SHA256SUMS.txt

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          generate_release_notes: true
          files: release/*
