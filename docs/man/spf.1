.TH SPF 1 "December 2025" "spf 2.1.0" "User Commands"
.SH NAME
spf \- simple, self-hosted port forwarder and tunnel
.SH SYNOPSIS
.B spf
.RI [ global-options ]
.br
.B spf expose
.I <port>
.RI [--relay	host] [--name	subdomain]
.br
.B spf tunnel
.I <relay> <local-port>
.br
.B spf relay
.I <domain>
.RI [--port	n] [--tunnel-port	n] [--cert	hex] [--key	hex]
.br
.B spf
.RI -f "listen:target:port"
.br
.B spf
.RI [--config	hpath] [--daemon] [--cert	hfile] [--key	hfile]
.SH DESCRIPTION
.B spf
is a lightweight TCP port forwarder and self-hosted tunnel that can expose local services from behind NAT/CGNAT without third parties. It aims to replace cloud tunnels (e.g., Cloudflare Tunnel, ngrok) with a single binary and a small VPS relay.
.PP
Key capabilities:
.RS
.IP \(bu 2
Expose local ports via an outbound tunnel (no port forwarding needed).
.IP \(bu 2
Run your own relay on a VPS and map subdomains to local services.
.IP \(bu 2
One-liner forwarding (like socat/rinetd) with TLS, load balancing, and health checks.
.IP \(bu 2
Hot reload via SIGHUP, JSON access logs, security hooks, and Prometheus metrics.
.RE
.SH COMMANDS
.TP
.B expose <port> [--relay host] [--name subdomain]
Create an outbound tunnel from localhost:<port> to a relay. If no name is provided, a random subdomain is generated by the relay.
.RS
.IP --relay
Relay hostname (and optional :port). Defaults to the public relay configured on the server.
.IP --name
Requested subdomain at the relay (e.g., myapp -> https://myapp.example.com).
.RE
.TP
.B tunnel <relay> <local-port>
Lower-level tunnel client (similar to expose) when you want explicit relay/port syntax.
.TP
.B relay <domain> [--port n] [--tunnel-port n] [--cert file] [--key file]
Run the relay on a VPS with a public IP. Listens on HTTPS public port and a control/tunnel port.
.RS
.IP --port
Public HTTPS port for users (default: 443).
.IP --tunnel-port
Control/data port for tunnel clients (default: 7000).
.IP --cert, --key
TLS certificate and key to terminate HTTPS at the relay.
.RE
.TP
.B -f listen:target:port
One-liner forward (L4 proxy). Example: \fBspf -f 8080:backend:80\fR.
.SH GLOBAL OPTIONS
.TP
.B -C, --config <path>
Load config file (default: spf.conf).
.TP
.B -c, --cert <path>
TLS certificate for local termination (forward mode).
.TP
.B -k, --key <path>
TLS private key for local termination.
.TP
.B -d, --daemon
Run as background daemon.
.TP
.B -H, --hooks-dir <path>
Directory with custom security hooks.
.TP
.B -A, --access-log <path>
JSON access log file path.
.TP
.B -h, --help
Show context-sensitive help.
.SH EXAMPLES
.SS Expose a local app behind NAT
.EX
spf expose 3000 --relay myvps.com --name blog
.EE
Result: https://blog.myvps.com points to localhost:3000 via outbound tunnel.
.SS Quick forward (like socat)
.EX
spf -f 8080:api.internal:80
.EE
Listens on 8080, forwards to api.internal:80.
.SS Run your own relay on a VPS
.EX
spf relay mydomain.com --cert cert.pem --key key.pem
.EE
Relay listens on 443 for users and 7000 for tunnel clients.
.SH CONFIGURATION
Configuration is optional for simple one-liners. For multiple rules, use a config file (default spf.conf) or the control socket (port 8081 by default). Rules support load balancing (rr, lc, ip, w), per-rule connection caps, and accept-rate throttling.
.SH HOOKS
Hooks are executable scripts in a hooks directory invoked on connection events. Environment variables include SPF_CLIENT_IP, SPF_CLIENT_PORT, SPF_RULE_ID, SPF_BACKEND_IP, SPF_BACKEND_PORT. Exit codes: 0 ALLOW, 1 BLOCK, 2 RATE_LIMIT.
.SH LOGGING
Access logs can be enabled with \fB--access-log\fR and are JSON-formatted (client IP, ports, backend, bytes, duration). Security events and health changes are logged to stderr/syslog (depending on service setup).
.SH SIGNALS
.TP
.B SIGHUP
Reload configuration.
.TP
.B SIGINT, SIGTERM
Graceful shutdown.
.SH FILES
.TP
.I /usr/local/bin/spf
Installed binary.
.TP
.I /etc/spf/spf.conf
Optional configuration file (if deployed system-wide).
.TP
.I /etc/spf/hooks.d/
Optional hooks directory.
.SH EXIT STATUS
.B spf
exits 0 on success, non-zero on errors (invalid arguments, bind failures, TLS errors, tunnel failures).
.SH SECURITY
Run the relay on a hardened VPS with TLS. Use auth tokens for the control plane. Validate ports (spf refuses invalid ports). Prefer non-root by binding high ports or using auth-managed capabilities. Keep OpenSSL up to date.
.SH SEE ALSO
socat(1), rinetd(8)
